6dc7fc9a5adbf5fbba8fdc925452d426
'use strict';

var BatchedBridge = require('BatchedBridge');

var EventEmitter = require('EventEmitter');

var Set = require('Set');

var TaskQueue = require('TaskQueue');

var infoLog = require('infoLog');

var invariant = require('fbjs/lib/invariant');

var keyMirror = require('fbjs/lib/keyMirror');

var _emitter = new EventEmitter();

var DEBUG_DELAY = 0;
var DEBUG = false;
var InteractionManager = {
  Events: keyMirror({
    interactionStart: true,
    interactionComplete: true
  }),
  runAfterInteractions: function runAfterInteractions(task) {
    var tasks = [];
    var promise = new Promise(function (resolve) {
      _scheduleUpdate();

      if (task) {
        tasks.push(task);
      }

      tasks.push({
        run: resolve,
        name: 'resolve ' + (task && task.name || '?')
      });

      _taskQueue.enqueueTasks(tasks);
    });
    return {
      then: promise.then.bind(promise),
      done: function done() {
        if (promise.done) {
          return promise.done.apply(promise, arguments);
        } else {
          console.warn('Tried to call done when not supported by current Promise implementation.');
        }
      },
      cancel: function cancel() {
        _taskQueue.cancelTasks(tasks);
      }
    };
  },
  createInteractionHandle: function createInteractionHandle() {
    DEBUG && infoLog('create interaction handle');

    _scheduleUpdate();

    var handle = ++_inc;

    _addInteractionSet.add(handle);

    return handle;
  },
  clearInteractionHandle: function clearInteractionHandle(handle) {
    DEBUG && infoLog('clear interaction handle');
    invariant(!!handle, 'Must provide a handle to clear.');

    _scheduleUpdate();

    _addInteractionSet.delete(handle);

    _deleteInteractionSet.add(handle);
  },
  addListener: _emitter.addListener.bind(_emitter),
  setDeadline: function setDeadline(deadline) {
    _deadline = deadline;
  }
};

var _interactionSet = new Set();

var _addInteractionSet = new Set();

var _deleteInteractionSet = new Set();

var _taskQueue = new TaskQueue({
  onMoreTasks: _scheduleUpdate
});

var _nextUpdateHandle = 0;
var _inc = 0;

var _deadline = -1;

function _scheduleUpdate() {
  if (!_nextUpdateHandle) {
    if (_deadline > 0) {
      _nextUpdateHandle = setTimeout(_processUpdate, 0 + DEBUG_DELAY);
    } else {
      _nextUpdateHandle = setImmediate(_processUpdate);
    }
  }
}

function _processUpdate() {
  _nextUpdateHandle = 0;
  var interactionCount = _interactionSet.size;

  _addInteractionSet.forEach(function (handle) {
    return _interactionSet.add(handle);
  });

  _deleteInteractionSet.forEach(function (handle) {
    return _interactionSet.delete(handle);
  });

  var nextInteractionCount = _interactionSet.size;

  if (interactionCount !== 0 && nextInteractionCount === 0) {
    _emitter.emit(InteractionManager.Events.interactionComplete);
  } else if (interactionCount === 0 && nextInteractionCount !== 0) {
    _emitter.emit(InteractionManager.Events.interactionStart);
  }

  if (nextInteractionCount === 0) {
    while (_taskQueue.hasTasksToProcess()) {
      _taskQueue.processNext();

      if (_deadline > 0 && BatchedBridge.getEventLoopRunningTime() >= _deadline) {
        _scheduleUpdate();

        break;
      }
    }
  }

  _addInteractionSet.clear();

  _deleteInteractionSet.clear();
}

module.exports = InteractionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkludGVyYWN0aW9uTWFuYWdlci5qcyJdLCJuYW1lcyI6WyJCYXRjaGVkQnJpZGdlIiwicmVxdWlyZSIsIkV2ZW50RW1pdHRlciIsIlNldCIsIlRhc2tRdWV1ZSIsImluZm9Mb2ciLCJpbnZhcmlhbnQiLCJrZXlNaXJyb3IiLCJfZW1pdHRlciIsIkRFQlVHX0RFTEFZIiwiREVCVUciLCJJbnRlcmFjdGlvbk1hbmFnZXIiLCJFdmVudHMiLCJpbnRlcmFjdGlvblN0YXJ0IiwiaW50ZXJhY3Rpb25Db21wbGV0ZSIsInJ1bkFmdGVySW50ZXJhY3Rpb25zIiwidGFzayIsInRhc2tzIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwiX3NjaGVkdWxlVXBkYXRlIiwicHVzaCIsInJ1biIsIm5hbWUiLCJfdGFza1F1ZXVlIiwiZW5xdWV1ZVRhc2tzIiwidGhlbiIsImJpbmQiLCJkb25lIiwiY29uc29sZSIsIndhcm4iLCJjYW5jZWwiLCJjYW5jZWxUYXNrcyIsImNyZWF0ZUludGVyYWN0aW9uSGFuZGxlIiwiaGFuZGxlIiwiX2luYyIsIl9hZGRJbnRlcmFjdGlvblNldCIsImFkZCIsImNsZWFySW50ZXJhY3Rpb25IYW5kbGUiLCJkZWxldGUiLCJfZGVsZXRlSW50ZXJhY3Rpb25TZXQiLCJhZGRMaXN0ZW5lciIsInNldERlYWRsaW5lIiwiZGVhZGxpbmUiLCJfZGVhZGxpbmUiLCJfaW50ZXJhY3Rpb25TZXQiLCJvbk1vcmVUYXNrcyIsIl9uZXh0VXBkYXRlSGFuZGxlIiwic2V0VGltZW91dCIsIl9wcm9jZXNzVXBkYXRlIiwic2V0SW1tZWRpYXRlIiwiaW50ZXJhY3Rpb25Db3VudCIsInNpemUiLCJmb3JFYWNoIiwibmV4dEludGVyYWN0aW9uQ291bnQiLCJlbWl0IiwiaGFzVGFza3NUb1Byb2Nlc3MiLCJwcm9jZXNzTmV4dCIsImdldEV2ZW50TG9vcFJ1bm5pbmdUaW1lIiwiY2xlYXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFVQTs7QUFF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QUFBLFdBQUlXLGVBQWUsQ0FBQ04sTUFBaEIsQ0FBdUJMLE1BQXZCLENBQUo7QUFBQSxHQUFwQzs7QUFDQSxNQUFNb0Isb0JBQW9CLEdBQUdULGVBQWUsQ0FBQ08sSUFBN0M7O0FBRUEsTUFBSUQsZ0JBQWdCLEtBQUssQ0FBckIsSUFBMEJHLG9CQUFvQixLQUFLLENBQXZELEVBQTBEO0FBRXhEL0MsSUFBQUEsUUFBUSxDQUFDZ0QsSUFBVCxDQUFjN0Msa0JBQWtCLENBQUNDLE1BQW5CLENBQTBCRSxtQkFBeEM7QUFDRCxHQUhELE1BR08sSUFBSXNDLGdCQUFnQixLQUFLLENBQXJCLElBQTBCRyxvQkFBb0IsS0FBSyxDQUF2RCxFQUEwRDtBQUUvRC9DLElBQUFBLFFBQVEsQ0FBQ2dELElBQVQsQ0FBYzdDLGtCQUFrQixDQUFDQyxNQUFuQixDQUEwQkMsZ0JBQXhDO0FBQ0Q7O0FBR0QsTUFBSTBDLG9CQUFvQixLQUFLLENBQTdCLEVBQWdDO0FBQzlCLFdBQU85QixVQUFVLENBQUNnQyxpQkFBWCxFQUFQLEVBQXVDO0FBQ3JDaEMsTUFBQUEsVUFBVSxDQUFDaUMsV0FBWDs7QUFDQSxVQUNFYixTQUFTLEdBQUcsQ0FBWixJQUNBN0MsYUFBYSxDQUFDMkQsdUJBQWQsTUFBMkNkLFNBRjdDLEVBR0U7QUFFQXhCLFFBQUFBLGVBQWU7O0FBQ2Y7QUFDRDtBQUNGO0FBQ0Y7O0FBQ0RnQixFQUFBQSxrQkFBa0IsQ0FBQ3VCLEtBQW5COztBQUNBbkIsRUFBQUEscUJBQXFCLENBQUNtQixLQUF0QjtBQUNEOztBQUVEQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJuRCxrQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmb3JtYXRcbiAqIEBmbG93XG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBCYXRjaGVkQnJpZGdlID0gcmVxdWlyZSgnQmF0Y2hlZEJyaWRnZScpO1xuY29uc3QgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnRXZlbnRFbWl0dGVyJyk7XG5jb25zdCBTZXQgPSByZXF1aXJlKCdTZXQnKTtcbmNvbnN0IFRhc2tRdWV1ZSA9IHJlcXVpcmUoJ1Rhc2tRdWV1ZScpO1xuXG5jb25zdCBpbmZvTG9nID0gcmVxdWlyZSgnaW5mb0xvZycpO1xuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnZmJqcy9saWIvaW52YXJpYW50Jyk7XG4vKiAkRmxvd0ZpeE1lKD49MC41NC4wIHNpdGU9cmVhY3RfbmF0aXZlX29zcykgVGhpcyBjb21tZW50IHN1cHByZXNzZXMgYW4gZXJyb3JcbiAqIGZvdW5kIHdoZW4gRmxvdyB2MC41NCB3YXMgZGVwbG95ZWQuIFRvIHNlZSB0aGUgZXJyb3IgZGVsZXRlIHRoaXMgY29tbWVudCBhbmRcbiAqIHJ1biBGbG93LiAqL1xuY29uc3Qga2V5TWlycm9yID0gcmVxdWlyZSgnZmJqcy9saWIva2V5TWlycm9yJyk7XG5cbnR5cGUgSGFuZGxlID0gbnVtYmVyO1xuaW1wb3J0IHR5cGUge1Rhc2t9IGZyb20gJ1Rhc2tRdWV1ZSc7XG5cbmNvbnN0IF9lbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG5jb25zdCBERUJVR19ERUxBWSA9IDA7XG5jb25zdCBERUJVRyA9IGZhbHNlO1xuXG4vKipcbiAqIEludGVyYWN0aW9uTWFuYWdlciBhbGxvd3MgbG9uZy1ydW5uaW5nIHdvcmsgdG8gYmUgc2NoZWR1bGVkIGFmdGVyIGFueVxuICogaW50ZXJhY3Rpb25zL2FuaW1hdGlvbnMgaGF2ZSBjb21wbGV0ZWQuIEluIHBhcnRpY3VsYXIsIHRoaXMgYWxsb3dzIEphdmFTY3JpcHRcbiAqIGFuaW1hdGlvbnMgdG8gcnVuIHNtb290aGx5LlxuICpcbiAqIEFwcGxpY2F0aW9ucyBjYW4gc2NoZWR1bGUgdGFza3MgdG8gcnVuIGFmdGVyIGludGVyYWN0aW9ucyB3aXRoIHRoZSBmb2xsb3dpbmc6XG4gKlxuICogYGBgXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIucnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKCkgPT4ge1xuICogICAvLyAuLi5sb25nLXJ1bm5pbmcgc3luY2hyb25vdXMgdGFzay4uLlxuICogfSk7XG4gKiBgYGBcbiAqXG4gKiBDb21wYXJlIHRoaXMgdG8gb3RoZXIgc2NoZWR1bGluZyBhbHRlcm5hdGl2ZXM6XG4gKlxuICogLSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKTogZm9yIGNvZGUgdGhhdCBhbmltYXRlcyBhIHZpZXcgb3ZlciB0aW1lLlxuICogLSBzZXRJbW1lZGlhdGUvc2V0VGltZW91dCgpOiBydW4gY29kZSBsYXRlciwgbm90ZSB0aGlzIG1heSBkZWxheSBhbmltYXRpb25zLlxuICogLSBydW5BZnRlckludGVyYWN0aW9ucygpOiBydW4gY29kZSBsYXRlciwgd2l0aG91dCBkZWxheWluZyBhY3RpdmUgYW5pbWF0aW9ucy5cbiAqXG4gKiBUaGUgdG91Y2ggaGFuZGxpbmcgc3lzdGVtIGNvbnNpZGVycyBvbmUgb3IgbW9yZSBhY3RpdmUgdG91Y2hlcyB0byBiZSBhblxuICogJ2ludGVyYWN0aW9uJyBhbmQgd2lsbCBkZWxheSBgcnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKWAgY2FsbGJhY2tzIHVudGlsIGFsbFxuICogdG91Y2hlcyBoYXZlIGVuZGVkIG9yIGJlZW4gY2FuY2VsbGVkLlxuICpcbiAqIEludGVyYWN0aW9uTWFuYWdlciBhbHNvIGFsbG93cyBhcHBsaWNhdGlvbnMgdG8gcmVnaXN0ZXIgYW5pbWF0aW9ucyBieVxuICogY3JlYXRpbmcgYW4gaW50ZXJhY3Rpb24gJ2hhbmRsZScgb24gYW5pbWF0aW9uIHN0YXJ0LCBhbmQgY2xlYXJpbmcgaXQgdXBvblxuICogY29tcGxldGlvbjpcbiAqXG4gKiBgYGBcbiAqIHZhciBoYW5kbGUgPSBJbnRlcmFjdGlvbk1hbmFnZXIuY3JlYXRlSW50ZXJhY3Rpb25IYW5kbGUoKTtcbiAqIC8vIHJ1biBhbmltYXRpb24uLi4gKGBydW5BZnRlckludGVyYWN0aW9uc2AgdGFza3MgYXJlIHF1ZXVlZClcbiAqIC8vIGxhdGVyLCBvbiBhbmltYXRpb24gY29tcGxldGlvbjpcbiAqIEludGVyYWN0aW9uTWFuYWdlci5jbGVhckludGVyYWN0aW9uSGFuZGxlKGhhbmRsZSk7XG4gKiAvLyBxdWV1ZWQgdGFza3MgcnVuIGlmIGFsbCBoYW5kbGVzIHdlcmUgY2xlYXJlZFxuICogYGBgXG4gKlxuICogYHJ1bkFmdGVySW50ZXJhY3Rpb25zYCB0YWtlcyBlaXRoZXIgYSBwbGFpbiBjYWxsYmFjayBmdW5jdGlvbiwgb3IgYVxuICogYFByb21pc2VUYXNrYCBvYmplY3Qgd2l0aCBhIGBnZW5gIG1ldGhvZCB0aGF0IHJldHVybnMgYSBgUHJvbWlzZWAuICBJZiBhXG4gKiBgUHJvbWlzZVRhc2tgIGlzIHN1cHBsaWVkLCB0aGVuIGl0IGlzIGZ1bGx5IHJlc29sdmVkIChpbmNsdWRpbmcgYXN5bmNocm9ub3VzXG4gKiBkZXBlbmRlbmNpZXMgdGhhdCBhbHNvIHNjaGVkdWxlIG1vcmUgdGFza3MgdmlhIGBydW5BZnRlckludGVyYWN0aW9uc2ApIGJlZm9yZVxuICogc3RhcnRpbmcgb24gdGhlIG5leHQgdGFzayB0aGF0IG1pZ2h0IGhhdmUgYmVlbiBxdWV1ZWQgdXAgc3luY2hyb25vdXNseVxuICogZWFybGllci5cbiAqXG4gKiBCeSBkZWZhdWx0LCBxdWV1ZWQgdGFza3MgYXJlIGV4ZWN1dGVkIHRvZ2V0aGVyIGluIGEgbG9vcCBpbiBvbmVcbiAqIGBzZXRJbW1lZGlhdGVgIGJhdGNoLiBJZiBgc2V0RGVhZGxpbmVgIGlzIGNhbGxlZCB3aXRoIGEgcG9zaXRpdmUgbnVtYmVyLCB0aGVuXG4gKiB0YXNrcyB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgdW50aWwgdGhlIGRlYWRsaW5lIChpbiB0ZXJtcyBvZiBqcyBldmVudCBsb29wIHJ1blxuICogdGltZSkgYXBwcm9hY2hlcywgYXQgd2hpY2ggcG9pbnQgZXhlY3V0aW9uIHdpbGwgeWllbGQgdmlhIHNldFRpbWVvdXQsXG4gKiBhbGxvd2luZyBldmVudHMgc3VjaCBhcyB0b3VjaGVzIHRvIHN0YXJ0IGludGVyYWN0aW9ucyBhbmQgYmxvY2sgcXVldWVkIHRhc2tzXG4gKiBmcm9tIGV4ZWN1dGluZywgbWFraW5nIGFwcHMgbW9yZSByZXNwb25zaXZlLlxuICovXG5jb25zdCBJbnRlcmFjdGlvbk1hbmFnZXIgPSB7XG4gIEV2ZW50czoga2V5TWlycm9yKHtcbiAgICBpbnRlcmFjdGlvblN0YXJ0OiB0cnVlLFxuICAgIGludGVyYWN0aW9uQ29tcGxldGU6IHRydWUsXG4gIH0pLFxuXG4gIC8qKlxuICAgKiBTY2hlZHVsZSBhIGZ1bmN0aW9uIHRvIHJ1biBhZnRlciBhbGwgaW50ZXJhY3Rpb25zIGhhdmUgY29tcGxldGVkLiBSZXR1cm5zIGEgY2FuY2VsbGFibGVcbiAgICogXCJwcm9taXNlXCIuXG4gICAqL1xuICBydW5BZnRlckludGVyYWN0aW9ucyhcbiAgICB0YXNrOiA/VGFzayxcbiAgKToge3RoZW46IEZ1bmN0aW9uLCBkb25lOiBGdW5jdGlvbiwgY2FuY2VsOiBGdW5jdGlvbn0ge1xuICAgIGNvbnN0IHRhc2tzID0gW107XG4gICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgICBpZiAodGFzaykge1xuICAgICAgICB0YXNrcy5wdXNoKHRhc2spO1xuICAgICAgfVxuICAgICAgdGFza3MucHVzaCh7XG4gICAgICAgIHJ1bjogcmVzb2x2ZSxcbiAgICAgICAgbmFtZTogJ3Jlc29sdmUgJyArICgodGFzayAmJiB0YXNrLm5hbWUpIHx8ICc/JyksXG4gICAgICB9KTtcbiAgICAgIF90YXNrUXVldWUuZW5xdWV1ZVRhc2tzKHRhc2tzKTtcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgdGhlbjogcHJvbWlzZS50aGVuLmJpbmQocHJvbWlzZSksXG4gICAgICBkb25lOiAoLi4uYXJncykgPT4ge1xuICAgICAgICBpZiAocHJvbWlzZS5kb25lKSB7XG4gICAgICAgICAgcmV0dXJuIHByb21pc2UuZG9uZSguLi5hcmdzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICAnVHJpZWQgdG8gY2FsbCBkb25lIHdoZW4gbm90IHN1cHBvcnRlZCBieSBjdXJyZW50IFByb21pc2UgaW1wbGVtZW50YXRpb24uJyxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgY2FuY2VsOiBmdW5jdGlvbigpIHtcbiAgICAgICAgX3Rhc2tRdWV1ZS5jYW5jZWxUYXNrcyh0YXNrcyk7XG4gICAgICB9LFxuICAgIH07XG4gIH0sXG5cbiAgLyoqXG4gICAqIE5vdGlmeSBtYW5hZ2VyIHRoYXQgYW4gaW50ZXJhY3Rpb24gaGFzIHN0YXJ0ZWQuXG4gICAqL1xuICBjcmVhdGVJbnRlcmFjdGlvbkhhbmRsZSgpOiBIYW5kbGUge1xuICAgIERFQlVHICYmIGluZm9Mb2coJ2NyZWF0ZSBpbnRlcmFjdGlvbiBoYW5kbGUnKTtcbiAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICBjb25zdCBoYW5kbGUgPSArK19pbmM7XG4gICAgX2FkZEludGVyYWN0aW9uU2V0LmFkZChoYW5kbGUpO1xuICAgIHJldHVybiBoYW5kbGU7XG4gIH0sXG5cbiAgLyoqXG4gICAqIE5vdGlmeSBtYW5hZ2VyIHRoYXQgYW4gaW50ZXJhY3Rpb24gaGFzIGNvbXBsZXRlZC5cbiAgICovXG4gIGNsZWFySW50ZXJhY3Rpb25IYW5kbGUoaGFuZGxlOiBIYW5kbGUpIHtcbiAgICBERUJVRyAmJiBpbmZvTG9nKCdjbGVhciBpbnRlcmFjdGlvbiBoYW5kbGUnKTtcbiAgICBpbnZhcmlhbnQoISFoYW5kbGUsICdNdXN0IHByb3ZpZGUgYSBoYW5kbGUgdG8gY2xlYXIuJyk7XG4gICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgX2FkZEludGVyYWN0aW9uU2V0LmRlbGV0ZShoYW5kbGUpO1xuICAgIF9kZWxldGVJbnRlcmFjdGlvblNldC5hZGQoaGFuZGxlKTtcbiAgfSxcblxuICBhZGRMaXN0ZW5lcjogX2VtaXR0ZXIuYWRkTGlzdGVuZXIuYmluZChfZW1pdHRlciksXG5cbiAgLyoqXG4gICAqIEEgcG9zaXRpdmUgbnVtYmVyIHdpbGwgdXNlIHNldFRpbWVvdXQgdG8gc2NoZWR1bGUgYW55IHRhc2tzIGFmdGVyIHRoZVxuICAgKiBldmVudExvb3BSdW5uaW5nVGltZSBoaXRzIHRoZSBkZWFkbGluZSB2YWx1ZSwgb3RoZXJ3aXNlIGFsbCB0YXNrcyB3aWxsIGJlXG4gICAqIGV4ZWN1dGVkIGluIG9uZSBzZXRJbW1lZGlhdGUgYmF0Y2ggKGRlZmF1bHQpLlxuICAgKi9cbiAgc2V0RGVhZGxpbmUoZGVhZGxpbmU6IG51bWJlcikge1xuICAgIF9kZWFkbGluZSA9IGRlYWRsaW5lO1xuICB9LFxufTtcblxuY29uc3QgX2ludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX2FkZEludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX2RlbGV0ZUludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX3Rhc2tRdWV1ZSA9IG5ldyBUYXNrUXVldWUoe29uTW9yZVRhc2tzOiBfc2NoZWR1bGVVcGRhdGV9KTtcbmxldCBfbmV4dFVwZGF0ZUhhbmRsZSA9IDA7XG5sZXQgX2luYyA9IDA7XG5sZXQgX2RlYWRsaW5lID0gLTE7XG5cbmRlY2xhcmUgZnVuY3Rpb24gc2V0SW1tZWRpYXRlKGNhbGxiYWNrOiBhbnksIC4uLmFyZ3M6IEFycmF5PGFueT4pOiBudW1iZXI7XG5cbi8qKlxuICogU2NoZWR1bGUgYW4gYXN5bmNocm9ub3VzIHVwZGF0ZSB0byB0aGUgaW50ZXJhY3Rpb24gc3RhdGUuXG4gKi9cbmZ1bmN0aW9uIF9zY2hlZHVsZVVwZGF0ZSgpIHtcbiAgaWYgKCFfbmV4dFVwZGF0ZUhhbmRsZSkge1xuICAgIGlmIChfZGVhZGxpbmUgPiAwKSB7XG4gICAgICAvKiAkRmxvd0ZpeE1lKD49MC42My4wIHNpdGU9cmVhY3RfbmF0aXZlX2ZiKSBUaGlzIGNvbW1lbnQgc3VwcHJlc3NlcyBhblxuICAgICAgICogZXJyb3IgZm91bmQgd2hlbiBGbG93IHYwLjYzIHdhcyBkZXBsb3llZC4gVG8gc2VlIHRoZSBlcnJvciBkZWxldGUgdGhpc1xuICAgICAgICogY29tbWVudCBhbmQgcnVuIEZsb3cuICovXG4gICAgICBfbmV4dFVwZGF0ZUhhbmRsZSA9IHNldFRpbWVvdXQoX3Byb2Nlc3NVcGRhdGUsIDAgKyBERUJVR19ERUxBWSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIF9uZXh0VXBkYXRlSGFuZGxlID0gc2V0SW1tZWRpYXRlKF9wcm9jZXNzVXBkYXRlKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBOb3RpZnkgbGlzdGVuZXJzLCBwcm9jZXNzIHF1ZXVlLCBldGNcbiAqL1xuZnVuY3Rpb24gX3Byb2Nlc3NVcGRhdGUoKSB7XG4gIF9uZXh0VXBkYXRlSGFuZGxlID0gMDtcblxuICBjb25zdCBpbnRlcmFjdGlvbkNvdW50ID0gX2ludGVyYWN0aW9uU2V0LnNpemU7XG4gIF9hZGRJbnRlcmFjdGlvblNldC5mb3JFYWNoKGhhbmRsZSA9PiBfaW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSkpO1xuICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuZm9yRWFjaChoYW5kbGUgPT4gX2ludGVyYWN0aW9uU2V0LmRlbGV0ZShoYW5kbGUpKTtcbiAgY29uc3QgbmV4dEludGVyYWN0aW9uQ291bnQgPSBfaW50ZXJhY3Rpb25TZXQuc2l6ZTtcblxuICBpZiAoaW50ZXJhY3Rpb25Db3VudCAhPT0gMCAmJiBuZXh0SW50ZXJhY3Rpb25Db3VudCA9PT0gMCkge1xuICAgIC8vIHRyYW5zaXRpb24gZnJvbSAxKyAtLT4gMCBpbnRlcmFjdGlvbnNcbiAgICBfZW1pdHRlci5lbWl0KEludGVyYWN0aW9uTWFuYWdlci5FdmVudHMuaW50ZXJhY3Rpb25Db21wbGV0ZSk7XG4gIH0gZWxzZSBpZiAoaW50ZXJhY3Rpb25Db3VudCA9PT0gMCAmJiBuZXh0SW50ZXJhY3Rpb25Db3VudCAhPT0gMCkge1xuICAgIC8vIHRyYW5zaXRpb24gZnJvbSAwIC0tPiAxKyBpbnRlcmFjdGlvbnNcbiAgICBfZW1pdHRlci5lbWl0KEludGVyYWN0aW9uTWFuYWdlci5FdmVudHMuaW50ZXJhY3Rpb25TdGFydCk7XG4gIH1cblxuICAvLyBwcm9jZXNzIHRoZSBxdWV1ZSByZWdhcmRsZXNzIG9mIGEgdHJhbnNpdGlvblxuICBpZiAobmV4dEludGVyYWN0aW9uQ291bnQgPT09IDApIHtcbiAgICB3aGlsZSAoX3Rhc2tRdWV1ZS5oYXNUYXNrc1RvUHJvY2VzcygpKSB7XG4gICAgICBfdGFza1F1ZXVlLnByb2Nlc3NOZXh0KCk7XG4gICAgICBpZiAoXG4gICAgICAgIF9kZWFkbGluZSA+IDAgJiZcbiAgICAgICAgQmF0Y2hlZEJyaWRnZS5nZXRFdmVudExvb3BSdW5uaW5nVGltZSgpID49IF9kZWFkbGluZVxuICAgICAgKSB7XG4gICAgICAgIC8vIEhpdCBkZWFkbGluZSBiZWZvcmUgcHJvY2Vzc2luZyBhbGwgdGFza3MsIHNvIHByb2Nlc3MgbW9yZSBsYXRlci5cbiAgICAgICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBfYWRkSW50ZXJhY3Rpb25TZXQuY2xlYXIoKTtcbiAgX2RlbGV0ZUludGVyYWN0aW9uU2V0LmNsZWFyKCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gSW50ZXJhY3Rpb25NYW5hZ2VyO1xuIl19