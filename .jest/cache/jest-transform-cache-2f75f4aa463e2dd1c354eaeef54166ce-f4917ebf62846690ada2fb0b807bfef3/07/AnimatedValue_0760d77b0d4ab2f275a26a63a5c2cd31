e5bf64be9b966e3551b7edceb3b629d7
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var AnimatedInterpolation = require('./AnimatedInterpolation');

var AnimatedNode = require('./AnimatedNode');

var AnimatedWithChildren = require('./AnimatedWithChildren');

var InteractionManager = require('InteractionManager');

var NativeAnimatedHelper = require('../NativeAnimatedHelper');

var NativeAnimatedAPI = NativeAnimatedHelper.API;
var _uniqueId = 1;

function _flush(rootNode) {
  var animatedStyles = new Set();

  function findAnimatedStyles(node) {
    if (typeof node.update === 'function') {
      animatedStyles.add(node);
    } else {
      node.__getChildren().forEach(findAnimatedStyles);
    }
  }

  findAnimatedStyles(rootNode);
  animatedStyles.forEach(function (animatedStyle) {
    return animatedStyle.update();
  });
}

var AnimatedValue = function (_AnimatedWithChildren) {
  (0, _inherits2.default)(AnimatedValue, _AnimatedWithChildren);

  function AnimatedValue(value) {
    var _this;

    (0, _classCallCheck2.default)(this, AnimatedValue);
    _this = (0, _possibleConstructorReturn2.default)(this, (0, _getPrototypeOf2.default)(AnimatedValue).call(this));
    _this._startingValue = _this._value = value;
    _this._offset = 0;
    _this._animation = null;
    _this._listeners = {};
    return _this;
  }

  (0, _createClass2.default)(AnimatedValue, [{
    key: "__detach",
    value: function __detach() {
      this.stopAnimation();
      (0, _get2.default)((0, _getPrototypeOf2.default)(AnimatedValue.prototype), "__detach", this).call(this);
    }
  }, {
    key: "__getValue",
    value: function __getValue() {
      return this._value + this._offset;
    }
  }, {
    key: "__makeNative",
    value: function __makeNative() {
      (0, _get2.default)((0, _getPrototypeOf2.default)(AnimatedValue.prototype), "__makeNative", this).call(this);

      if (Object.keys(this._listeners).length) {
        this._startListeningToNativeValueUpdates();
      }
    }
  }, {
    key: "setValue",
    value: function setValue(value) {
      if (this._animation) {
        this._animation.stop();

        this._animation = null;
      }

      this._updateValue(value, !this.__isNative);

      if (this.__isNative) {
        NativeAnimatedAPI.setAnimatedNodeValue(this.__getNativeTag(), value);
      }
    }
  }, {
    key: "setOffset",
    value: function setOffset(offset) {
      this._offset = offset;

      if (this.__isNative) {
        NativeAnimatedAPI.setAnimatedNodeOffset(this.__getNativeTag(), offset);
      }
    }
  }, {
    key: "flattenOffset",
    value: function flattenOffset() {
      this._value += this._offset;
      this._offset = 0;

      if (this.__isNative) {
        NativeAnimatedAPI.flattenAnimatedNodeOffset(this.__getNativeTag());
      }
    }
  }, {
    key: "extractOffset",
    value: function extractOffset() {
      this._offset += this._value;
      this._value = 0;

      if (this.__isNative) {
        NativeAnimatedAPI.extractAnimatedNodeOffset(this.__getNativeTag());
      }
    }
  }, {
    key: "addListener",
    value: function addListener(callback) {
      var id = String(_uniqueId++);
      this._listeners[id] = callback;

      if (this.__isNative) {
        this._startListeningToNativeValueUpdates();
      }

      return id;
    }
  }, {
    key: "removeListener",
    value: function removeListener(id) {
      delete this._listeners[id];

      if (this.__isNative && Object.keys(this._listeners).length === 0) {
        this._stopListeningForNativeValueUpdates();
      }
    }
  }, {
    key: "removeAllListeners",
    value: function removeAllListeners() {
      this._listeners = {};

      if (this.__isNative) {
        this._stopListeningForNativeValueUpdates();
      }
    }
  }, {
    key: "_startListeningToNativeValueUpdates",
    value: function _startListeningToNativeValueUpdates() {
      var _this2 = this;

      if (this.__nativeAnimatedValueListener) {
        return;
      }

      NativeAnimatedAPI.startListeningToAnimatedNodeValue(this.__getNativeTag());
      this.__nativeAnimatedValueListener = NativeAnimatedHelper.nativeEventEmitter.addListener('onAnimatedValueUpdate', function (data) {
        if (data.tag !== _this2.__getNativeTag()) {
          return;
        }

        _this2._updateValue(data.value, false);
      });
    }
  }, {
    key: "_stopListeningForNativeValueUpdates",
    value: function _stopListeningForNativeValueUpdates() {
      if (!this.__nativeAnimatedValueListener) {
        return;
      }

      this.__nativeAnimatedValueListener.remove();

      this.__nativeAnimatedValueListener = null;
      NativeAnimatedAPI.stopListeningToAnimatedNodeValue(this.__getNativeTag());
    }
  }, {
    key: "stopAnimation",
    value: function stopAnimation(callback) {
      this.stopTracking();
      this._animation && this._animation.stop();
      this._animation = null;
      callback && callback(this.__getValue());
    }
  }, {
    key: "resetAnimation",
    value: function resetAnimation(callback) {
      this.stopAnimation(callback);
      this._value = this._startingValue;
    }
  }, {
    key: "interpolate",
    value: function interpolate(config) {
      return new AnimatedInterpolation(this, config);
    }
  }, {
    key: "animate",
    value: function animate(animation, callback) {
      var _this3 = this;

      var handle = null;

      if (animation.__isInteraction) {
        handle = InteractionManager.createInteractionHandle();
      }

      var previousAnimation = this._animation;
      this._animation && this._animation.stop();
      this._animation = animation;
      animation.start(this._value, function (value) {
        _this3._updateValue(value, true);
      }, function (result) {
        _this3._animation = null;

        if (handle !== null) {
          InteractionManager.clearInteractionHandle(handle);
        }

        callback && callback(result);
      }, previousAnimation, this);
    }
  }, {
    key: "stopTracking",
    value: function stopTracking() {
      this._tracking && this._tracking.__detach();
      this._tracking = null;
    }
  }, {
    key: "track",
    value: function track(tracking) {
      this.stopTracking();
      this._tracking = tracking;
    }
  }, {
    key: "_updateValue",
    value: function _updateValue(value, flush) {
      this._value = value;

      if (flush) {
        _flush(this);
      }

      for (var _key in this._listeners) {
        this._listeners[_key]({
          value: this.__getValue()
        });
      }
    }
  }, {
    key: "__getNativeConfig",
    value: function __getNativeConfig() {
      return {
        type: 'value',
        value: this._value,
        offset: this._offset
      };
    }
  }]);
  return AnimatedValue;
}(AnimatedWithChildren);

module.exports = AnimatedValue;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFuaW1hdGVkVmFsdWUuanMiXSwibmFtZXMiOlsiQW5pbWF0ZWRJbnRlcnBvbGF0aW9uIiwicmVxdWlyZSIsIkFuaW1hdGVkTm9kZSIsIkFuaW1hdGVkV2l0aENoaWxkcmVuIiwiSW50ZXJhY3Rpb25NYW5hZ2VyIiwiTmF0aXZlQW5pbWF0ZWRIZWxwZXIiLCJOYXRpdmVBbmltYXRlZEFQSSIsIkFQSSIsIl91bmlxdWVJZCIsIl9mbHVzaCIsInJvb3ROb2RlIiwiYW5pbWF0ZWRTdHlsZXMiLCJTZXQiLCJmaW5kQW5pbWF0ZWRTdHlsZXMiLCJub2RlIiwidXBkYXRlIiwiYWRkIiwiX19nZXRDaGlsZHJlbiIsImZvckVhY2giLCJhbmltYXRlZFN0eWxlIiwiQW5pbWF0ZWRWYWx1ZSIsInZhbHVlIiwiX3N0YXJ0aW5nVmFsdWUiLCJfdmFsdWUiLCJfb2Zmc2V0IiwiX2FuaW1hdGlvbiIsIl9saXN0ZW5lcnMiLCJzdG9wQW5pbWF0aW9uIiwiT2JqZWN0Iiwia2V5cyIsImxlbmd0aCIsIl9zdGFydExpc3RlbmluZ1RvTmF0aXZlVmFsdWVVcGRhdGVzIiwic3RvcCIsIl91cGRhdGVWYWx1ZSIsIl9faXNOYXRpdmUiLCJzZXRBbmltYXRlZE5vZGVWYWx1ZSIsIl9fZ2V0TmF0aXZlVGFnIiwib2Zmc2V0Iiwic2V0QW5pbWF0ZWROb2RlT2Zmc2V0IiwiZmxhdHRlbkFuaW1hdGVkTm9kZU9mZnNldCIsImV4dHJhY3RBbmltYXRlZE5vZGVPZmZzZXQiLCJjYWxsYmFjayIsImlkIiwiU3RyaW5nIiwiX3N0b3BMaXN0ZW5pbmdGb3JOYXRpdmVWYWx1ZVVwZGF0ZXMiLCJfX25hdGl2ZUFuaW1hdGVkVmFsdWVMaXN0ZW5lciIsInN0YXJ0TGlzdGVuaW5nVG9BbmltYXRlZE5vZGVWYWx1ZSIsIm5hdGl2ZUV2ZW50RW1pdHRlciIsImFkZExpc3RlbmVyIiwiZGF0YSIsInRhZyIsInJlbW92ZSIsInN0b3BMaXN0ZW5pbmdUb0FuaW1hdGVkTm9kZVZhbHVlIiwic3RvcFRyYWNraW5nIiwiX19nZXRWYWx1ZSIsImNvbmZpZyIsImFuaW1hdGlvbiIsImhhbmRsZSIsIl9faXNJbnRlcmFjdGlvbiIsImNyZWF0ZUludGVyYWN0aW9uSGFuZGxlIiwicHJldmlvdXNBbmltYXRpb24iLCJzdGFydCIsInJlc3VsdCIsImNsZWFySW50ZXJhY3Rpb25IYW5kbGUiLCJfdHJhY2tpbmciLCJfX2RldGFjaCIsInRyYWNraW5nIiwiZmx1c2giLCJrZXkiLCJ0eXBlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBU0E7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxxQkFBcUIsR0FBR0MsT0FBTyxDQUFDLHlCQUFELENBQXJDOztBQUNBLElBQU1DLFlBQVksR0FBR0QsT0FBTyxDQUFDLGdCQUFELENBQTVCOztBQUNBLElBQU1FLG9CQUFvQixHQUFHRixPQUFPLENBQUMsd0JBQUQsQ0FBcEM7O0FBQ0EsSUFBTUcsa0JBQWtCLEdBQUdILE9BQU8sQ0FBQyxvQkFBRCxDQUFsQzs7QUFDQSxJQUFNSSxvQkFBb0IsR0FBR0osT0FBTyxDQUFDLHlCQUFELENBQXBDOztBQU1BLElBQU1LLGlCQUFpQixHQUFHRCxvQkFBb0IsQ0FBQ0UsR0FBL0M7QUFJQSxJQUFJQyxTQUFTLEdBQUcsQ0FBaEI7O0FBd0JBLFNBQVNDLE1BQVQsQ0FBZ0JDLFFBQWhCLEVBQStDO0FBQzdDLE1BQU1DLGNBQWMsR0FBRyxJQUFJQyxHQUFKLEVBQXZCOztBQUNBLFdBQVNDLGtCQUFULENBQTRCQyxJQUE1QixFQUFrQztBQUloQyxRQUFJLE9BQU9BLElBQUksQ0FBQ0MsTUFBWixLQUF1QixVQUEzQixFQUF1QztBQUNyQ0osTUFBQUEsY0FBYyxDQUFDSyxHQUFmLENBQW1CRixJQUFuQjtBQUNELEtBRkQsTUFFTztBQUNMQSxNQUFBQSxJQUFJLENBQUNHLGFBQUwsR0FBcUJDLE9BQXJCLENBQTZCTCxrQkFBN0I7QUFDRDtBQUNGOztBQUNEQSxFQUFBQSxrQkFBa0IsQ0FBQ0gsUUFBRCxDQUFsQjtBQUVBQyxFQUFBQSxjQUFj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O0FBQ0Y7Ozt3Q0FFMkI7QUFDMUIsYUFBTztBQUNMZSxRQUFBQSxJQUFJLEVBQUUsT0FERDtBQUVMaEQsUUFBQUEsS0FBSyxFQUFFLEtBQUtFLE1BRlA7QUFHTGMsUUFBQUEsTUFBTSxFQUFFLEtBQUtiO0FBSFIsT0FBUDtBQUtEOzs7RUFyUXlCckIsb0I7O0FBd1E1Qm1FLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQm5ELGFBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICogQGZvcm1hdFxuICovXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IEFuaW1hdGVkSW50ZXJwb2xhdGlvbiA9IHJlcXVpcmUoJy4vQW5pbWF0ZWRJbnRlcnBvbGF0aW9uJyk7XG5jb25zdCBBbmltYXRlZE5vZGUgPSByZXF1aXJlKCcuL0FuaW1hdGVkTm9kZScpO1xuY29uc3QgQW5pbWF0ZWRXaXRoQ2hpbGRyZW4gPSByZXF1aXJlKCcuL0FuaW1hdGVkV2l0aENoaWxkcmVuJyk7XG5jb25zdCBJbnRlcmFjdGlvbk1hbmFnZXIgPSByZXF1aXJlKCdJbnRlcmFjdGlvbk1hbmFnZXInKTtcbmNvbnN0IE5hdGl2ZUFuaW1hdGVkSGVscGVyID0gcmVxdWlyZSgnLi4vTmF0aXZlQW5pbWF0ZWRIZWxwZXInKTtcblxuaW1wb3J0IHR5cGUgQW5pbWF0aW9uLCB7RW5kQ2FsbGJhY2t9IGZyb20gJy4uL2FuaW1hdGlvbnMvQW5pbWF0aW9uJztcbmltcG9ydCB0eXBlIHtJbnRlcnBvbGF0aW9uQ29uZmlnVHlwZX0gZnJvbSAnLi9BbmltYXRlZEludGVycG9sYXRpb24nO1xuaW1wb3J0IHR5cGUgQW5pbWF0ZWRUcmFja2luZyBmcm9tICcuL0FuaW1hdGVkVHJhY2tpbmcnO1xuXG5jb25zdCBOYXRpdmVBbmltYXRlZEFQSSA9IE5hdGl2ZUFuaW1hdGVkSGVscGVyLkFQSTtcblxudHlwZSBWYWx1ZUxpc3RlbmVyQ2FsbGJhY2sgPSAoc3RhdGU6IHt2YWx1ZTogbnVtYmVyfSkgPT4gdm9pZDtcblxubGV0IF91bmlxdWVJZCA9IDE7XG5cbi8qKlxuICogQW5pbWF0ZWQgd29ya3MgYnkgYnVpbGRpbmcgYSBkaXJlY3RlZCBhY3ljbGljIGdyYXBoIG9mIGRlcGVuZGVuY2llc1xuICogdHJhbnNwYXJlbnRseSB3aGVuIHlvdSByZW5kZXIgeW91ciBBbmltYXRlZCBjb21wb25lbnRzLlxuICpcbiAqICAgICAgICAgICAgICAgbmV3IEFuaW1hdGVkLlZhbHVlKDApXG4gKiAgICAgLmludGVycG9sYXRlKCkgICAgICAgIC5pbnRlcnBvbGF0ZSgpICAgIG5ldyBBbmltYXRlZC5WYWx1ZSgxKVxuICogICAgICAgICBvcGFjaXR5ICAgICAgICAgICAgICAgdHJhbnNsYXRlWSAgICAgIHNjYWxlXG4gKiAgICAgICAgICBzdHlsZSAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1cbiAqICAgICAgICAgVmlldyMyMzQgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBWaWV3IzEyM1xuICpcbiAqIEEpIFRvcCBEb3duIHBoYXNlXG4gKiBXaGVuIGFuIEFuaW1hdGVkLlZhbHVlIGlzIHVwZGF0ZWQsIHdlIHJlY3Vyc2l2ZWx5IGdvIGRvd24gdGhyb3VnaCB0aGlzXG4gKiBncmFwaCBpbiBvcmRlciB0byBmaW5kIGxlYWYgbm9kZXM6IHRoZSB2aWV3cyB0aGF0IHdlIGZsYWcgYXMgbmVlZGluZ1xuICogYW4gdXBkYXRlLlxuICpcbiAqIEIpIEJvdHRvbSBVcCBwaGFzZVxuICogV2hlbiBhIHZpZXcgaXMgZmxhZ2dlZCBhcyBuZWVkaW5nIGFuIHVwZGF0ZSwgd2UgcmVjdXJzaXZlbHkgZ28gYmFjayB1cFxuICogaW4gb3JkZXIgdG8gYnVpbGQgdGhlIG5ldyB2YWx1ZSB0aGF0IGl0IG5lZWRzLiBUaGUgcmVhc29uIHdoeSB3ZSBuZWVkXG4gKiB0aGlzIHR3by1waGFzZXMgcHJvY2VzcyBpcyB0byBkZWFsIHdpdGggY29tcG9zaXRlIHByb3BzIHN1Y2ggYXNcbiAqIHRyYW5zZm9ybSB3aGljaCBjYW4gcmVjZWl2ZSB2YWx1ZXMgZnJvbSBtdWx0aXBsZSBwYXJlbnRzLlxuICovXG5mdW5jdGlvbiBfZmx1c2gocm9vdE5vZGU6IEFuaW1hdGVkVmFsdWUpOiB2b2lkIHtcbiAgY29uc3QgYW5pbWF0ZWRTdHlsZXMgPSBuZXcgU2V0KCk7XG4gIGZ1bmN0aW9uIGZpbmRBbmltYXRlZFN0eWxlcyhub2RlKSB7XG4gICAgLyogJEZsb3dGaXhNZSg+PTAuNjguMCBzaXRlPXJlYWN0X25hdGl2ZV9mYikgVGhpcyBjb21tZW50IHN1cHByZXNzZXMgYW5cbiAgICAgKiBlcnJvciBmb3VuZCB3aGVuIEZsb3cgdjAuNjggd2FzIGRlcGxveWVkLiBUbyBzZWUgdGhlIGVycm9yIGRlbGV0ZSB0aGlzXG4gICAgICogY29tbWVudCBhbmQgcnVuIEZsb3cuICovXG4gICAgaWYgKHR5cGVvZiBub2RlLnVwZGF0ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgYW5pbWF0ZWRTdHlsZXMuYWRkKG5vZGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBub2RlLl9fZ2V0Q2hpbGRyZW4oKS5mb3JFYWNoKGZpbmRBbmltYXRlZFN0eWxlcyk7XG4gICAgfVxuICB9XG4gIGZpbmRBbmltYXRlZFN0eWxlcyhyb290Tm9kZSk7XG4gIC8qICRGbG93Rml4TWUgKi9cbiAgYW5pbWF0ZWRTdHlsZXMuZm9yRWFjaChhbmltYXRlZFN0eWxlID0+IGFuaW1hdGVkU3R5bGUudXBkYXRlKCkpO1xufVxuXG4vKipcbiAqIFN0YW5kYXJkIHZhbHVlIGZvciBkcml2aW5nIGFuaW1hdGlvbnMuICBPbmUgYEFuaW1hdGVkLlZhbHVlYCBjYW4gZHJpdmVcbiAqIG11bHRpcGxlIHByb3BlcnRpZXMgaW4gYSBzeW5jaHJvbml6ZWQgZmFzaGlvbiwgYnV0IGNhbiBvbmx5IGJlIGRyaXZlbiBieSBvbmVcbiAqIG1lY2hhbmlzbSBhdCBhIHRpbWUuICBVc2luZyBhIG5ldyBtZWNoYW5pc20gKGUuZy4gc3RhcnRpbmcgYSBuZXcgYW5pbWF0aW9uLFxuICogb3IgY2FsbGluZyBgc2V0VmFsdWVgKSB3aWxsIHN0b3AgYW55IHByZXZpb3VzIG9uZXMuXG4gKlxuICogU2VlIGh0dHA6Ly9mYWNlYm9vay5naXRodWIuaW8vcmVhY3QtbmF0aXZlL2RvY3MvYW5pbWF0ZWR2YWx1ZS5odG1sXG4gKi9cbmNsYXNzIEFuaW1hdGVkVmFsdWUgZXh0ZW5kcyBBbmltYXRlZFdpdGhDaGlsZHJlbiB7XG4gIF92YWx1ZTogbnVtYmVyO1xuICBfc3RhcnRpbmdWYWx1ZTogbnVtYmVyO1xuICBfb2Zmc2V0OiBudW1iZXI7XG4gIF9hbmltYXRpb246ID9BbmltYXRpb247XG4gIF90cmFja2luZzogP0FuaW1hdGVkVHJhY2tpbmc7XG4gIF9saXN0ZW5lcnM6IHtba2V5OiBzdHJpbmddOiBWYWx1ZUxpc3RlbmVyQ2FsbGJhY2t9O1xuICBfX25hdGl2ZUFuaW1hdGVkVmFsdWVMaXN0ZW5lcjogP2FueTtcblxuICBjb25zdHJ1Y3Rvcih2YWx1ZTogbnVtYmVyKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9zdGFydGluZ1ZhbHVlID0gdGhpcy5fdmFsdWUgPSB2YWx1ZTtcbiAgICB0aGlzLl9vZmZzZXQgPSAwO1xuICAgIHRoaXMuX2FuaW1hdGlvbiA9IG51bGw7XG4gICAgdGhpcy5fbGlzdGVuZXJzID0ge307XG4gIH1cblxuICBfX2RldGFjaCgpIHtcbiAgICB0aGlzLnN0b3BBbmltYXRpb24oKTtcbiAgICBzdXBlci5fX2RldGFjaCgpO1xuICB9XG5cbiAgX19nZXRWYWx1ZSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZSArIHRoaXMuX29mZnNldDtcbiAgfVxuXG4gIF9fbWFrZU5hdGl2ZSgpIHtcbiAgICBzdXBlci5fX21ha2VOYXRpdmUoKTtcblxuICAgIGlmIChPYmplY3Qua2V5cyh0aGlzLl9saXN0ZW5lcnMpLmxlbmd0aCkge1xuICAgICAgdGhpcy5fc3RhcnRMaXN0ZW5pbmdUb05hdGl2ZVZhbHVlVXBkYXRlcygpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEaXJlY3RseSBzZXQgdGhlIHZhbHVlLiAgVGhpcyB3aWxsIHN0b3AgYW55IGFuaW1hdGlvbnMgcnVubmluZyBvbiB0aGUgdmFsdWVcbiAgICogYW5kIHVwZGF0ZSBhbGwgdGhlIGJvdW5kIHByb3BlcnRpZXMuXG4gICAqXG4gICAqIFNlZSBodHRwOi8vZmFjZWJvb2suZ2l0aHViLmlvL3JlYWN0LW5hdGl2ZS9kb2NzL2FuaW1hdGVkdmFsdWUuaHRtbCNzZXR2YWx1ZVxuICAgKi9cbiAgc2V0VmFsdWUodmFsdWU6IG51bWJlcik6IHZvaWQge1xuICAgIGlmICh0aGlzLl9hbmltYXRpb24pIHtcbiAgICAgIHRoaXMuX2FuaW1hdGlvbi5zdG9wKCk7XG4gICAgICB0aGlzLl9hbmltYXRpb24gPSBudWxsO1xuICAgIH1cbiAgICB0aGlzLl91cGRhdGVWYWx1ZShcbiAgICAgIHZhbHVlLFxuICAgICAgIXRoaXMuX19pc05hdGl2ZSAvKiBkb24ndCBwZXJmb3JtIGEgZmx1c2ggZm9yIG5hdGl2ZWx5IGRyaXZlbiB2YWx1ZXMgKi8sXG4gICAgKTtcbiAgICBpZiAodGhpcy5fX2lzTmF0aXZlKSB7XG4gICAgICBOYXRpdmVBbmltYXRlZEFQSS5zZXRBbmltYXRlZE5vZGVWYWx1ZSh0aGlzLl9fZ2V0TmF0aXZlVGFnKCksIHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0cyBhbiBvZmZzZXQgdGhhdCBpcyBhcHBsaWVkIG9uIHRvcCBvZiB3aGF0ZXZlciB2YWx1ZSBpcyBzZXQsIHdoZXRoZXIgdmlhXG4gICAqIGBzZXRWYWx1ZWAsIGFuIGFuaW1hdGlvbiwgb3IgYEFuaW1hdGVkLmV2ZW50YC4gIFVzZWZ1bCBmb3IgY29tcGVuc2F0aW5nXG4gICAqIHRoaW5ncyBsaWtlIHRoZSBzdGFydCBvZiBhIHBhbiBnZXN0dXJlLlxuICAgKlxuICAgKiBTZWUgaHR0cDovL2ZhY2Vib29rLmdpdGh1Yi5pby9yZWFjdC1uYXRpdmUvZG9jcy9hbmltYXRlZHZhbHVlLmh0bWwjc2V0b2Zmc2V0XG4gICAqL1xuICBzZXRPZmZzZXQob2Zmc2V0OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLl9vZmZzZXQgPSBvZmZzZXQ7XG4gICAgaWYgKHRoaXMuX19pc05hdGl2ZSkge1xuICAgICAgTmF0aXZlQW5pbWF0ZWRBUEkuc2V0QW5pbWF0ZWROb2RlT2Zmc2V0KHRoaXMuX19nZXROYXRpdmVUYWcoKSwgb2Zmc2V0KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTWVyZ2VzIHRoZSBvZmZzZXQgdmFsdWUgaW50byB0aGUgYmFzZSB2YWx1ZSBhbmQgcmVzZXRzIHRoZSBvZmZzZXQgdG8gemVyby5cbiAgICogVGhlIGZpbmFsIG91dHB1dCBvZiB0aGUgdmFsdWUgaXMgdW5jaGFuZ2VkLlxuICAgKlxuICAgKiBTZWUgaHR0cDovL2ZhY2Vib29rLmdpdGh1Yi5pby9yZWFjdC1uYXRpdmUvZG9jcy9hbmltYXRlZHZhbHVlLmh0bWwjZmxhdHRlbm9mZnNldFxuICAgKi9cbiAgZmxhdHRlbk9mZnNldCgpOiB2b2lkIHtcbiAgICB0aGlzLl92YWx1ZSArPSB0aGlzLl9vZmZzZXQ7XG4gICAgdGhpcy5fb2Zmc2V0ID0gMDtcbiAgICBpZiAodGhpcy5fX2lzTmF0aXZlKSB7XG4gICAgICBOYXRpdmVBbmltYXRlZEFQSS5mbGF0dGVuQW5pbWF0ZWROb2RlT2Zmc2V0KHRoaXMuX19nZXROYXRpdmVUYWcoKSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIG9mZnNldCB2YWx1ZSB0byB0aGUgYmFzZSB2YWx1ZSwgYW5kIHJlc2V0cyB0aGUgYmFzZSB2YWx1ZSB0byB6ZXJvLlxuICAgKiBUaGUgZmluYWwgb3V0cHV0IG9mIHRoZSB2YWx1ZSBpcyB1bmNoYW5nZWQuXG4gICAqXG4gICAqIFNlZSBodHRwOi8vZmFjZWJvb2suZ2l0aHViLmlvL3JlYWN0LW5hdGl2ZS9kb2NzL2FuaW1hdGVkdmFsdWUuaHRtbCNleHRyYWN0b2Zmc2V0XG4gICAqL1xuICBleHRyYWN0T2Zmc2V0KCk6IHZvaWQge1xuICAgIHRoaXMuX29mZnNldCArPSB0aGlzLl92YWx1ZTtcbiAgICB0aGlzLl92YWx1ZSA9IDA7XG4gICAgaWYgKHRoaXMuX19pc05hdGl2ZSkge1xuICAgICAgTmF0aXZlQW5pbWF0ZWRBUEkuZXh0cmFjdEFuaW1hdGVkTm9kZU9mZnNldCh0aGlzLl9fZ2V0TmF0aXZlVGFnKCkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGFuIGFzeW5jaHJvbm91cyBsaXN0ZW5lciB0byB0aGUgdmFsdWUgc28geW91IGNhbiBvYnNlcnZlIHVwZGF0ZXMgZnJvbVxuICAgKiBhbmltYXRpb25zLiAgVGhpcyBpcyB1c2VmdWwgYmVjYXVzZSB0aGVyZSBpcyBubyB3YXkgdG9cbiAgICogc3luY2hyb25vdXNseSByZWFkIHRoZSB2YWx1ZSBiZWNhdXNlIGl0IG1pZ2h0IGJlIGRyaXZlbiBuYXRpdmVseS5cbiAgICpcbiAgICogU2VlIGh0dHA6Ly9mYWNlYm9vay5naXRodWIuaW8vcmVhY3QtbmF0aXZlL2RvY3MvYW5pbWF0ZWR2YWx1ZS5odG1sI2FkZGxpc3RlbmVyXG4gICAqL1xuICBhZGRMaXN0ZW5lcihjYWxsYmFjazogVmFsdWVMaXN0ZW5lckNhbGxiYWNrKTogc3RyaW5nIHtcbiAgICBjb25zdCBpZCA9IFN0cmluZyhfdW5pcXVlSWQrKyk7XG4gICAgdGhpcy5fbGlzdGVuZXJzW2lkXSA9IGNhbGxiYWNrO1xuICAgIGlmICh0aGlzLl9faXNOYXRpdmUpIHtcbiAgICAgIHRoaXMuX3N0YXJ0TGlzdGVuaW5nVG9OYXRpdmVWYWx1ZVVwZGF0ZXMoKTtcbiAgICB9XG4gICAgcmV0dXJuIGlkO1xuICB9XG5cbiAgLyoqXG4gICAqIFVucmVnaXN0ZXIgYSBsaXN0ZW5lci4gVGhlIGBpZGAgcGFyYW0gc2hhbGwgbWF0Y2ggdGhlIGlkZW50aWZpZXJcbiAgICogcHJldmlvdXNseSByZXR1cm5lZCBieSBgYWRkTGlzdGVuZXIoKWAuXG4gICAqXG4gICAqIFNlZSBodHRwOi8vZmFjZWJvb2suZ2l0aHViLmlvL3JlYWN0LW5hdGl2ZS9kb2NzL2FuaW1hdGVkdmFsdWUuaHRtbCNyZW1vdmVsaXN0ZW5lclxuICAgKi9cbiAgcmVtb3ZlTGlzdGVuZXIoaWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGRlbGV0ZSB0aGlzLl9saXN0ZW5lcnNbaWRdO1xuICAgIGlmICh0aGlzLl9faXNOYXRpdmUgJiYgT2JqZWN0LmtleXModGhpcy5fbGlzdGVuZXJzKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuX3N0b3BMaXN0ZW5pbmdGb3JOYXRpdmVWYWx1ZVVwZGF0ZXMoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGFsbCByZWdpc3RlcmVkIGxpc3RlbmVycy5cbiAgICpcbiAgICogU2VlIGh0dHA6Ly9mYWNlYm9vay5naXRodWIuaW8vcmVhY3QtbmF0aXZlL2RvY3MvYW5pbWF0ZWR2YWx1ZS5odG1sI3JlbW92ZWFsbGxpc3RlbmVyc1xuICAgKi9cbiAgcmVtb3ZlQWxsTGlzdGVuZXJzKCk6IHZvaWQge1xuICAgIHRoaXMuX2xpc3RlbmVycyA9IHt9O1xuICAgIGlmICh0aGlzLl9faXNOYXRpdmUpIHtcbiAgICAgIHRoaXMuX3N0b3BMaXN0ZW5pbmdGb3JOYXRpdmVWYWx1ZVVwZGF0ZXMoKTtcbiAgICB9XG4gIH1cblxuICBfc3RhcnRMaXN0ZW5pbmdUb05hdGl2ZVZhbHVlVXBkYXRlcygpIHtcbiAgICBpZiAodGhpcy5fX25hdGl2ZUFuaW1hdGVkVmFsdWVMaXN0ZW5lcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIE5hdGl2ZUFuaW1hdGVkQVBJLnN0YXJ0TGlzdGVuaW5nVG9BbmltYXRlZE5vZGVWYWx1ZSh0aGlzLl9fZ2V0TmF0aXZlVGFnKCkpO1xuICAgIHRoaXMuX19uYXRpdmVBbmltYXRlZFZhbHVlTGlzdGVuZXIgPSBOYXRpdmVBbmltYXRlZEhlbHBlci5uYXRpdmVFdmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIoXG4gICAgICAnb25BbmltYXRlZFZhbHVlVXBkYXRlJyxcbiAgICAgIGRhdGEgPT4ge1xuICAgICAgICBpZiAoZGF0YS50YWcgIT09IHRoaXMuX19nZXROYXRpdmVUYWcoKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl91cGRhdGVWYWx1ZShkYXRhLnZhbHVlLCBmYWxzZSAvKiBmbHVzaCAqLyk7XG4gICAgICB9LFxuICAgICk7XG4gIH1cblxuICBfc3RvcExpc3RlbmluZ0Zvck5hdGl2ZVZhbHVlVXBkYXRlcygpIHtcbiAgICBpZiAoIXRoaXMuX19uYXRpdmVBbmltYXRlZFZhbHVlTGlzdGVuZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLl9fbmF0aXZlQW5pbWF0ZWRWYWx1ZUxpc3RlbmVyLnJlbW92ZSgpO1xuICAgIHRoaXMuX19uYXRpdmVBbmltYXRlZFZhbHVlTGlzdGVuZXIgPSBudWxsO1xuICAgIE5hdGl2ZUFuaW1hdGVkQVBJLnN0b3BMaXN0ZW5pbmdUb0FuaW1hdGVkTm9kZVZhbHVlKHRoaXMuX19nZXROYXRpdmVUYWcoKSk7XG4gIH1cblxuICAvKipcbiAgICogU3RvcHMgYW55IHJ1bm5pbmcgYW5pbWF0aW9uIG9yIHRyYWNraW5nLiBgY2FsbGJhY2tgIGlzIGludm9rZWQgd2l0aCB0aGVcbiAgICogZmluYWwgdmFsdWUgYWZ0ZXIgc3RvcHBpbmcgdGhlIGFuaW1hdGlvbiwgd2hpY2ggaXMgdXNlZnVsIGZvciB1cGRhdGluZ1xuICAgKiBzdGF0ZSB0byBtYXRjaCB0aGUgYW5pbWF0aW9uIHBvc2l0aW9uIHdpdGggbGF5b3V0LlxuICAgKlxuICAgKiBTZWUgaHR0cDovL2ZhY2Vib29rLmdpdGh1Yi5pby9yZWFjdC1uYXRpdmUvZG9jcy9hbmltYXRlZHZhbHVlLmh0bWwjc3RvcGFuaW1hdGlvblxuICAgKi9cbiAgc3RvcEFuaW1hdGlvbihjYWxsYmFjaz86ID8odmFsdWU6IG51bWJlcikgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRoaXMuc3RvcFRyYWNraW5nKCk7XG4gICAgdGhpcy5fYW5pbWF0aW9uICYmIHRoaXMuX2FuaW1hdGlvbi5zdG9wKCk7XG4gICAgdGhpcy5fYW5pbWF0aW9uID0gbnVsbDtcbiAgICBjYWxsYmFjayAmJiBjYWxsYmFjayh0aGlzLl9fZ2V0VmFsdWUoKSk7XG4gIH1cblxuICAvKipcbiAgICogU3RvcHMgYW55IGFuaW1hdGlvbiBhbmQgcmVzZXRzIHRoZSB2YWx1ZSB0byBpdHMgb3JpZ2luYWwuXG4gICAqXG4gICAqIFNlZSBodHRwOi8vZmFjZWJvb2suZ2l0aHViLmlvL3JlYWN0LW5hdGl2ZS9kb2NzL2FuaW1hdGVkdmFsdWUuaHRtbCNyZXNldGFuaW1hdGlvblxuICAgKi9cbiAgcmVzZXRBbmltYXRpb24oY2FsbGJhY2s/OiA/KHZhbHVlOiBudW1iZXIpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3BBbmltYXRpb24oY2FsbGJhY2spO1xuICAgIHRoaXMuX3ZhbHVlID0gdGhpcy5fc3RhcnRpbmdWYWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnRlcnBvbGF0ZXMgdGhlIHZhbHVlIGJlZm9yZSB1cGRhdGluZyB0aGUgcHJvcGVydHksIGUuZy4gbWFwcGluZyAwLTEgdG9cbiAgICogMC0xMC5cbiAgICovXG4gIGludGVycG9sYXRlKGNvbmZpZzogSW50ZXJwb2xhdGlvbkNvbmZpZ1R5cGUpOiBBbmltYXRlZEludGVycG9sYXRpb24ge1xuICAgIHJldHVybiBuZXcgQW5pbWF0ZWRJbnRlcnBvbGF0aW9uKHRoaXMsIGNvbmZpZyk7XG4gIH1cblxuICAvKipcbiAgICogVHlwaWNhbGx5IG9ubHkgdXNlZCBpbnRlcm5hbGx5LCBidXQgY291bGQgYmUgdXNlZCBieSBhIGN1c3RvbSBBbmltYXRpb25cbiAgICogY2xhc3MuXG4gICAqXG4gICAqIFNlZSBodHRwOi8vZmFjZWJvb2suZ2l0aHViLmlvL3JlYWN0LW5hdGl2ZS9kb2NzL2FuaW1hdGVkdmFsdWUuaHRtbCNhbmltYXRlXG4gICAqL1xuICBhbmltYXRlKGFuaW1hdGlvbjogQW5pbWF0aW9uLCBjYWxsYmFjazogP0VuZENhbGxiYWNrKTogdm9pZCB7XG4gICAgbGV0IGhhbmRsZSA9IG51bGw7XG4gICAgaWYgKGFuaW1hdGlvbi5fX2lzSW50ZXJhY3Rpb24pIHtcbiAgICAgIGhhbmRsZSA9IEludGVyYWN0aW9uTWFuYWdlci5jcmVhdGVJbnRlcmFjdGlvbkhhbmRsZSgpO1xuICAgIH1cbiAgICBjb25zdCBwcmV2aW91c0FuaW1hdGlvbiA9IHRoaXMuX2FuaW1hdGlvbjtcbiAgICB0aGlzLl9hbmltYXRpb24gJiYgdGhpcy5fYW5pbWF0aW9uLnN0b3AoKTtcbiAgICB0aGlzLl9hbmltYXRpb24gPSBhbmltYXRpb247XG4gICAgYW5pbWF0aW9uLnN0YXJ0KFxuICAgICAgdGhpcy5fdmFsdWUsXG4gICAgICB2YWx1ZSA9PiB7XG4gICAgICAgIC8vIE5hdGl2ZWx5IGRyaXZlbiBhbmltYXRpb25zIHdpbGwgbmV2ZXIgY2FsbCBpbnRvIHRoYXQgY2FsbGJhY2ssIHRoZXJlZm9yZSB3ZSBjYW4gYWx3YXlzXG4gICAgICAgIC8vIHBhc3MgZmx1c2ggPSB0cnVlIHRvIGFsbG93IHRoZSB1cGRhdGVkIHZhbHVlIHRvIHByb3BhZ2F0ZSB0byBuYXRpdmUgd2l0aCBzZXROYXRpdmVQcm9wc1xuICAgICAgICB0aGlzLl91cGRhdGVWYWx1ZSh2YWx1ZSwgdHJ1ZSAvKiBmbHVzaCAqLyk7XG4gICAgICB9LFxuICAgICAgcmVzdWx0ID0+IHtcbiAgICAgICAgdGhpcy5fYW5pbWF0aW9uID0gbnVsbDtcbiAgICAgICAgaWYgKGhhbmRsZSAhPT0gbnVsbCkge1xuICAgICAgICAgIEludGVyYWN0aW9uTWFuYWdlci5jbGVhckludGVyYWN0aW9uSGFuZGxlKGhhbmRsZSk7XG4gICAgICAgIH1cbiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2socmVzdWx0KTtcbiAgICAgIH0sXG4gICAgICBwcmV2aW91c0FuaW1hdGlvbixcbiAgICAgIHRoaXMsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUeXBpY2FsbHkgb25seSB1c2VkIGludGVybmFsbHkuXG4gICAqL1xuICBzdG9wVHJhY2tpbmcoKTogdm9pZCB7XG4gICAgdGhpcy5fdHJhY2tpbmcgJiYgdGhpcy5fdHJhY2tpbmcuX19kZXRhY2goKTtcbiAgICB0aGlzLl90cmFja2luZyA9IG51bGw7XG4gIH1cblxuICAvKipcbiAgICogVHlwaWNhbGx5IG9ubHkgdXNlZCBpbnRlcm5hbGx5LlxuICAgKi9cbiAgdHJhY2sodHJhY2tpbmc6IEFuaW1hdGVkVHJhY2tpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3BUcmFja2luZygpO1xuICAgIHRoaXMuX3RyYWNraW5nID0gdHJhY2tpbmc7XG4gIH1cblxuICBfdXBkYXRlVmFsdWUodmFsdWU6IG51bWJlciwgZmx1c2g6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB0aGlzLl92YWx1ZSA9IHZhbHVlO1xuICAgIGlmIChmbHVzaCkge1xuICAgICAgX2ZsdXNoKHRoaXMpO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLl9saXN0ZW5lcnMpIHtcbiAgICAgIHRoaXMuX2xpc3RlbmVyc1trZXldKHt2YWx1ZTogdGhpcy5fX2dldFZhbHVlKCl9KTtcbiAgICB9XG4gIH1cblxuICBfX2dldE5hdGl2ZUNvbmZpZygpOiBPYmplY3Qge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAndmFsdWUnLFxuICAgICAgdmFsdWU6IHRoaXMuX3ZhbHVlLFxuICAgICAgb2Zmc2V0OiB0aGlzLl9vZmZzZXQsXG4gICAgfTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEFuaW1hdGVkVmFsdWU7XG4iXX0=