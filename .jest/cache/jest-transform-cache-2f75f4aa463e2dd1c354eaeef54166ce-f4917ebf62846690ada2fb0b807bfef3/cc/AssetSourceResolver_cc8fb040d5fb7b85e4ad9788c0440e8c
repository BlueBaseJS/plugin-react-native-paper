15b7c4e7682b84ed5c35135805324f5e
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var PixelRatio = require('PixelRatio');

var Platform = require('Platform');

var assetPathUtils = require('../../local-cli/bundle/assetPathUtils');

var invariant = require('fbjs/lib/invariant');

function getScaledAssetPath(asset) {
  var scale = AssetSourceResolver.pickScale(asset.scales, PixelRatio.get());
  var scaleSuffix = scale === 1 ? '' : '@' + scale + 'x';
  var assetDir = assetPathUtils.getBasePath(asset);
  return assetDir + '/' + asset.name + scaleSuffix + '.' + asset.type;
}

function getAssetPathInDrawableFolder(asset) {
  var scale = AssetSourceResolver.pickScale(asset.scales, PixelRatio.get());
  var drawbleFolder = assetPathUtils.getAndroidResourceFolderName(asset, scale);
  var fileName = assetPathUtils.getAndroidResourceIdentifier(asset);
  return drawbleFolder + '/' + fileName + '.' + asset.type;
}

var AssetSourceResolver = function () {
  function AssetSourceResolver(serverUrl, jsbundleUrl, asset) {
    (0, _classCallCheck2.default)(this, AssetSourceResolver);
    this.serverUrl = serverUrl;
    this.jsbundleUrl = jsbundleUrl;
    this.asset = asset;
  }

  (0, _createClass2.default)(AssetSourceResolver, [{
    key: "isLoadedFromServer",
    value: function isLoadedFromServer() {
      return !!this.serverUrl;
    }
  }, {
    key: "isLoadedFromFileSystem",
    value: function isLoadedFromFileSystem() {
      return !!(this.jsbundleUrl && this.jsbundleUrl.startsWith('file://'));
    }
  }, {
    key: "defaultAsset",
    value: function defaultAsset() {
      if (this.isLoadedFromServer()) {
        return this.assetServerURL();
      }

      if (Platform.OS === 'android') {
        return this.isLoadedFromFileSystem() ? this.drawableFolderInBundle() : this.resourceIdentifierWithoutScale();
      } else {
        return this.scaledAssetURLNearBundle();
      }
    }
  }, {
    key: "assetServerURL",
    value: function assetServerURL() {
      invariant(!!this.serverUrl, 'need server to load from');
      return this.fromSource(this.serverUrl + getScaledAssetPath(this.asset) + '?platform=' + Platform.OS + '&hash=' + this.asset.hash);
    }
  }, {
    key: "scaledAssetPath",
    value: function scaledAssetPath() {
      return this.fromSource(getScaledAssetPath(this.asset));
    }
  }, {
    key: "scaledAssetURLNearBundle",
    value: function scaledAssetURLNearBundle() {
      var path = this.jsbundleUrl || 'file://';
      return this.fromSource(path + getScaledAssetPath(this.asset));
    }
  }, {
    key: "resourceIdentifierWithoutScale",
    value: function resourceIdentifierWithoutScale() {
      invariant(Platform.OS === 'android', 'resource identifiers work on Android');
      return this.fromSource(assetPathUtils.getAndroidResourceIdentifier(this.asset));
    }
  }, {
    key: "drawableFolderInBundle",
    value: function drawableFolderInBundle() {
      var path = this.jsbundleUrl || 'file://';
      return this.fromSource(path + getAssetPathInDrawableFolder(this.asset));
    }
  }, {
    key: "fromSource",
    value: function fromSource(source) {
      return {
        __packager_asset: true,
        width: this.asset.width,
        height: this.asset.height,
        uri: source,
        scale: AssetSourceResolver.pickScale(this.asset.scales, PixelRatio.get())
      };
    }
  }], [{
    key: "pickScale",
    value: function pickScale(scales, deviceScale) {
      for (var i = 0; i < scales.length; i++) {
        if (scales[i] >= deviceScale) {
          return scales[i];
        }
      }

      return scales[scales.length - 1] || 1;
    }
  }]);
  return AssetSourceResolver;
}();

module.exports = AssetSourceResolver;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFzc2V0U291cmNlUmVzb2x2ZXIuanMiXSwibmFtZXMiOlsiUGl4ZWxSYXRpbyIsInJlcXVpcmUiLCJQbGF0Zm9ybSIsImFzc2V0UGF0aFV0aWxzIiwiaW52YXJpYW50IiwiZ2V0U2NhbGVkQXNzZXRQYXRoIiwiYXNzZXQiLCJzY2FsZSIsIkFzc2V0U291cmNlUmVzb2x2ZXIiLCJwaWNrU2NhbGUiLCJzY2FsZXMiLCJnZXQiLCJzY2FsZVN1ZmZpeCIsImFzc2V0RGlyIiwiZ2V0QmFzZVBhdGgiLCJuYW1lIiwidHlwZSIsImdldEFzc2V0UGF0aEluRHJhd2FibGVGb2xkZXIiLCJkcmF3YmxlRm9sZGVyIiwiZ2V0QW5kcm9pZFJlc291cmNlRm9sZGVyTmFtZSIsImZpbGVOYW1lIiwiZ2V0QW5kcm9pZFJlc291cmNlSWRlbnRpZmllciIsInNlcnZlclVybCIsImpzYnVuZGxlVXJsIiwic3RhcnRzV2l0aCIsImlzTG9hZGVkRnJvbVNlcnZlciIsImFzc2V0U2VydmVyVVJMIiwiT1MiLCJpc0xvYWRlZEZyb21GaWxlU3lzdGVtIiwiZHJhd2FibGVGb2xkZXJJbkJ1bmRsZSIsInJlc291cmNlSWRlbnRpZmllcldpdGhvdXRTY2FsZSIsInNjYWxlZEFzc2V0VVJMTmVhckJ1bmRsZSIsImZyb21Tb3VyY2UiLCJoYXNoIiwicGF0aCIsInNvdXJjZSIsIl9fcGFja2FnZXJfYXNzZXQiLCJ3aWR0aCIsImhlaWdodCIsInVyaSIsImRldmljZVNjYWxlIiwiaSIsImxlbmd0aCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVNBOzs7Ozs7OztBQVlBLElBQU1BLFVBQVUsR0FBR0MsT0FBTyxDQUFDLFlBQUQsQ0FBMUI7O0FBQ0EsSUFBTUMsUUFBUSxHQUFHRCxPQUFPLENBQUMsVUFBRCxDQUF4Qjs7QUFFQSxJQUFNRSxjQUFjLEdBQUdGLE9BQU8sQ0FBQyx1Q0FBRCxDQUE5Qjs7QUFDQSxJQUFNRyxTQUFTLEdBQUdILE9BQU8sQ0FBQyxvQkFBRCxDQUF6Qjs7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SyxVQUFMLENBQ0w3QixjQUFjLENBQUNrQiw0QkFBZixDQUE0QyxLQUFLZixLQUFqRCxDQURLLENBQVA7QUFHRDs7OzZDQU82QztBQUM1QyxVQUFNNEIsSUFBSSxHQUFHLEtBQUtYLFdBQUwsSUFBb0IsU0FBakM7QUFDQSxhQUFPLEtBQUtTLFVBQUwsQ0FBZ0JFLElBQUksR0FBR2pCLDRCQUE0QixDQUFDLEtBQUtYLEtBQU4sQ0FBbkQsQ0FBUDtBQUNEOzs7K0JBRVU2QixNLEVBQXFDO0FBQzlDLGFBQU87QUFDTEMsUUFBQUEsZ0JBQWdCLEVBQUUsSUFEYjtBQUVMQyxRQUFBQSxLQUFLLEVBQUUsS0FBSy9CLEtBQUwsQ0FBVytCLEtBRmI7QUFHTEMsUUFBQUEsTUFBTSxFQUFFLEtBQUtoQyxLQUFMLENBQVdnQyxNQUhkO0FBSUxDLFFBQUFBLEdBQUcsRUFBRUosTUFKQTtBQUtMNUIsUUFBQUEsS0FBSyxFQUFFQyxtQkFBbUIsQ0FBQ0MsU0FBcEIsQ0FBOEIsS0FBS0gsS0FBTCxDQUFXSSxNQUF6QyxFQUFpRFYsVUFBVSxDQUFDVyxHQUFYLEVBQWpEO0FBTEYsT0FBUDtBQU9EOzs7OEJBRWdCRCxNLEVBQXVCOEIsVyxFQUE2QjtBQUVuRSxXQUFLLElBQUlDLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUcvQixNQUFNLENBQUNnQyxNQUEzQixFQUFtQ0QsQ0FBQyxFQUFwQyxFQUF3QztBQUN0QyxZQUFJL0IsTUFBTSxDQUFDK0IsQ0FBRCxDQUFOLElBQWFELFdBQWpCLEVBQThCO0FBQzVCLGlCQUFPOUIsTUFBTSxDQUFDK0IsQ0FBRCxDQUFiO0FBQ0Q7QUFDRjs7QUFLRCxhQUFPL0IsTUFBTSxDQUFDQSxNQUFNLENBQUNnQyxNQUFQLEdBQWdCLENBQWpCLENBQU4sSUFBNkIsQ0FBcEM7QUFDRDs7Ozs7QUFHSEMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEMsbUJBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICogQGZvcm1hdFxuICovXG4ndXNlIHN0cmljdCc7XG5cbmV4cG9ydCB0eXBlIFJlc29sdmVkQXNzZXRTb3VyY2UgPSB7fFxuICArX19wYWNrYWdlcl9hc3NldDogYm9vbGVhbixcbiAgK3dpZHRoOiA/bnVtYmVyLFxuICAraGVpZ2h0OiA/bnVtYmVyLFxuICArdXJpOiBzdHJpbmcsXG4gICtzY2FsZTogbnVtYmVyLFxufH07XG5cbmltcG9ydCB0eXBlIHtQYWNrYWdlckFzc2V0fSBmcm9tICdBc3NldFJlZ2lzdHJ5JztcblxuY29uc3QgUGl4ZWxSYXRpbyA9IHJlcXVpcmUoJ1BpeGVsUmF0aW8nKTtcbmNvbnN0IFBsYXRmb3JtID0gcmVxdWlyZSgnUGxhdGZvcm0nKTtcblxuY29uc3QgYXNzZXRQYXRoVXRpbHMgPSByZXF1aXJlKCcuLi8uLi9sb2NhbC1jbGkvYnVuZGxlL2Fzc2V0UGF0aFV0aWxzJyk7XG5jb25zdCBpbnZhcmlhbnQgPSByZXF1aXJlKCdmYmpzL2xpYi9pbnZhcmlhbnQnKTtcblxuLyoqXG4gKiBSZXR1cm5zIGEgcGF0aCBsaWtlICdhc3NldHMvQXdlc29tZU1vZHVsZS9pY29uQDJ4LnBuZydcbiAqL1xuZnVuY3Rpb24gZ2V0U2NhbGVkQXNzZXRQYXRoKGFzc2V0KTogc3RyaW5nIHtcbiAgY29uc3Qgc2NhbGUgPSBBc3NldFNvdXJjZVJlc29sdmVyLnBpY2tTY2FsZShhc3NldC5zY2FsZXMsIFBpeGVsUmF0aW8uZ2V0KCkpO1xuICBjb25zdCBzY2FsZVN1ZmZpeCA9IHNjYWxlID09PSAxID8gJycgOiAnQCcgKyBzY2FsZSArICd4JztcbiAgY29uc3QgYXNzZXREaXIgPSBhc3NldFBhdGhVdGlscy5nZXRCYXNlUGF0aChhc3NldCk7XG4gIHJldHVybiBhc3NldERpciArICcvJyArIGFzc2V0Lm5hbWUgKyBzY2FsZVN1ZmZpeCArICcuJyArIGFzc2V0LnR5cGU7XG59XG5cbi8qKlxuICogUmV0dXJucyBhIHBhdGggbGlrZSAnZHJhd2FibGUtbWRwaS9pY29uLnBuZydcbiAqL1xuZnVuY3Rpb24gZ2V0QXNzZXRQYXRoSW5EcmF3YWJsZUZvbGRlcihhc3NldCk6IHN0cmluZyB7XG4gIGNvbnN0IHNjYWxlID0gQXNzZXRTb3VyY2VSZXNvbHZlci5waWNrU2NhbGUoYXNzZXQuc2NhbGVzLCBQaXhlbFJhdGlvLmdldCgpKTtcbiAgY29uc3QgZHJhd2JsZUZvbGRlciA9IGFzc2V0UGF0aFV0aWxzLmdldEFuZHJvaWRSZXNvdXJjZUZvbGRlck5hbWUoXG4gICAgYXNzZXQsXG4gICAgc2NhbGUsXG4gICk7XG4gIGNvbnN0IGZpbGVOYW1lID0gYXNzZXRQYXRoVXRpbHMuZ2V0QW5kcm9pZFJlc291cmNlSWRlbnRpZmllcihhc3NldCk7XG4gIHJldHVybiBkcmF3YmxlRm9sZGVyICsgJy8nICsgZmlsZU5hbWUgKyAnLicgKyBhc3NldC50eXBlO1xufVxuXG5jbGFzcyBBc3NldFNvdXJjZVJlc29sdmVyIHtcbiAgc2VydmVyVXJsOiA/c3RyaW5nO1xuICAvLyB3aGVyZSB0aGUganNidW5kbGUgaXMgYmVpbmcgcnVuIGZyb21cbiAganNidW5kbGVVcmw6ID9zdHJpbmc7XG4gIC8vIHRoZSBhc3NldCB0byByZXNvbHZlXG4gIGFzc2V0OiBQYWNrYWdlckFzc2V0O1xuXG4gIGNvbnN0cnVjdG9yKHNlcnZlclVybDogP3N0cmluZywganNidW5kbGVVcmw6ID9zdHJpbmcsIGFzc2V0OiBQYWNrYWdlckFzc2V0KSB7XG4gICAgdGhpcy5zZXJ2ZXJVcmwgPSBzZXJ2ZXJVcmw7XG4gICAgdGhpcy5qc2J1bmRsZVVybCA9IGpzYnVuZGxlVXJsO1xuICAgIHRoaXMuYXNzZXQgPSBhc3NldDtcbiAgfVxuXG4gIGlzTG9hZGVkRnJvbVNlcnZlcigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLnNlcnZlclVybDtcbiAgfVxuXG4gIGlzTG9hZGVkRnJvbUZpbGVTeXN0ZW0oKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhKHRoaXMuanNidW5kbGVVcmwgJiYgdGhpcy5qc2J1bmRsZVVybC5zdGFydHNXaXRoKCdmaWxlOi8vJykpO1xuICB9XG5cbiAgZGVmYXVsdEFzc2V0KCk6IFJlc29sdmVkQXNzZXRTb3VyY2Uge1xuICAgIGlmICh0aGlzLmlzTG9hZGVkRnJvbVNlcnZlcigpKSB7XG4gICAgICByZXR1cm4gdGhpcy5hc3NldFNlcnZlclVSTCgpO1xuICAgIH1cblxuICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7XG4gICAgICByZXR1cm4gdGhpcy5pc0xvYWRlZEZyb21GaWxlU3lzdGVtKClcbiAgICAgICAgPyB0aGlzLmRyYXdhYmxlRm9sZGVySW5CdW5kbGUoKVxuICAgICAgICA6IHRoaXMucmVzb3VyY2VJZGVudGlmaWVyV2l0aG91dFNjYWxlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLnNjYWxlZEFzc2V0VVJMTmVhckJ1bmRsZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIGFic29sdXRlIFVSTCB3aGljaCBjYW4gYmUgdXNlZCB0byBmZXRjaCB0aGUgYXNzZXRcbiAgICogZnJvbSB0aGUgZGV2c2VydmVyXG4gICAqL1xuICBhc3NldFNlcnZlclVSTCgpOiBSZXNvbHZlZEFzc2V0U291cmNlIHtcbiAgICBpbnZhcmlhbnQoISF0aGlzLnNlcnZlclVybCwgJ25lZWQgc2VydmVyIHRvIGxvYWQgZnJvbScpO1xuICAgIHJldHVybiB0aGlzLmZyb21Tb3VyY2UoXG4gICAgICB0aGlzLnNlcnZlclVybCArXG4gICAgICAgIGdldFNjYWxlZEFzc2V0UGF0aCh0aGlzLmFzc2V0KSArXG4gICAgICAgICc/cGxhdGZvcm09JyArXG4gICAgICAgIFBsYXRmb3JtLk9TICtcbiAgICAgICAgJyZoYXNoPScgK1xuICAgICAgICB0aGlzLmFzc2V0Lmhhc2gsXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNvbHZlcyB0byBqdXN0IHRoZSBzY2FsZWQgYXNzZXQgZmlsZW5hbWVcbiAgICogRS5nLiAnYXNzZXRzL0F3ZXNvbWVNb2R1bGUvaWNvbkAyeC5wbmcnXG4gICAqL1xuICBzY2FsZWRBc3NldFBhdGgoKTogUmVzb2x2ZWRBc3NldFNvdXJjZSB7XG4gICAgcmV0dXJuIHRoaXMuZnJvbVNvdXJjZShnZXRTY2FsZWRBc3NldFBhdGgodGhpcy5hc3NldCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc29sdmVzIHRvIHdoZXJlIHRoZSBidW5kbGUgaXMgcnVubmluZyBmcm9tLCB3aXRoIGEgc2NhbGVkIGFzc2V0IGZpbGVuYW1lXG4gICAqIEUuZy4gJ2ZpbGU6Ly8vc2RjYXJkL2J1bmRsZS9hc3NldHMvQXdlc29tZU1vZHVsZS9pY29uQDJ4LnBuZydcbiAgICovXG4gIHNjYWxlZEFzc2V0VVJMTmVhckJ1bmRsZSgpOiBSZXNvbHZlZEFzc2V0U291cmNlIHtcbiAgICBjb25zdCBwYXRoID0gdGhpcy5qc2J1bmRsZVVybCB8fCAnZmlsZTovLyc7XG4gICAgcmV0dXJuIHRoaXMuZnJvbVNvdXJjZShwYXRoICsgZ2V0U2NhbGVkQXNzZXRQYXRoKHRoaXMuYXNzZXQpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgZGVmYXVsdCBsb2NhdGlvbiBvZiBhc3NldHMgYnVuZGxlZCB3aXRoIHRoZSBhcHAsIGxvY2F0ZWQgYnlcbiAgICogcmVzb3VyY2UgaWRlbnRpZmllclxuICAgKiBUaGUgQW5kcm9pZCByZXNvdXJjZSBzeXN0ZW0gcGlja3MgdGhlIGNvcnJlY3Qgc2NhbGUuXG4gICAqIEUuZy4gJ2Fzc2V0c19hd2Vzb21lbW9kdWxlX2ljb24nXG4gICAqL1xuICByZXNvdXJjZUlkZW50aWZpZXJXaXRob3V0U2NhbGUoKTogUmVzb2x2ZWRBc3NldFNvdXJjZSB7XG4gICAgaW52YXJpYW50KFxuICAgICAgUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJyxcbiAgICAgICdyZXNvdXJjZSBpZGVudGlmaWVycyB3b3JrIG9uIEFuZHJvaWQnLFxuICAgICk7XG4gICAgcmV0dXJuIHRoaXMuZnJvbVNvdXJjZShcbiAgICAgIGFzc2V0UGF0aFV0aWxzLmdldEFuZHJvaWRSZXNvdXJjZUlkZW50aWZpZXIodGhpcy5hc3NldCksXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJZiB0aGUganNidW5kbGUgaXMgcnVubmluZyBmcm9tIGEgc2lkZWxvYWQgbG9jYXRpb24sIHRoaXMgcmVzb2x2ZXMgYXNzZXRzXG4gICAqIHJlbGF0aXZlIHRvIGl0cyBsb2NhdGlvblxuICAgKiBFLmcuICdmaWxlOi8vL3NkY2FyZC9Bd2Vzb21lTW9kdWxlL2RyYXdhYmxlLW1kcGkvaWNvbi5wbmcnXG4gICAqL1xuICBkcmF3YWJsZUZvbGRlckluQnVuZGxlKCk6IFJlc29sdmVkQXNzZXRTb3VyY2Uge1xuICAgIGNvbnN0IHBhdGggPSB0aGlzLmpzYnVuZGxlVXJsIHx8ICdmaWxlOi8vJztcbiAgICByZXR1cm4gdGhpcy5mcm9tU291cmNlKHBhdGggKyBnZXRBc3NldFBhdGhJbkRyYXdhYmxlRm9sZGVyKHRoaXMuYXNzZXQpKTtcbiAgfVxuXG4gIGZyb21Tb3VyY2Uoc291cmNlOiBzdHJpbmcpOiBSZXNvbHZlZEFzc2V0U291cmNlIHtcbiAgICByZXR1cm4ge1xuICAgICAgX19wYWNrYWdlcl9hc3NldDogdHJ1ZSxcbiAgICAgIHdpZHRoOiB0aGlzLmFzc2V0LndpZHRoLFxuICAgICAgaGVpZ2h0OiB0aGlzLmFzc2V0LmhlaWdodCxcbiAgICAgIHVyaTogc291cmNlLFxuICAgICAgc2NhbGU6IEFzc2V0U291cmNlUmVzb2x2ZXIucGlja1NjYWxlKHRoaXMuYXNzZXQuc2NhbGVzLCBQaXhlbFJhdGlvLmdldCgpKSxcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIHBpY2tTY2FsZShzY2FsZXM6IEFycmF5PG51bWJlcj4sIGRldmljZVNjYWxlOiBudW1iZXIpOiBudW1iZXIge1xuICAgIC8vIFBhY2thZ2VyIGd1YXJhbnRlZXMgdGhhdCBgc2NhbGVzYCBhcnJheSBpcyBzb3J0ZWRcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNjYWxlcy5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKHNjYWxlc1tpXSA+PSBkZXZpY2VTY2FsZSkge1xuICAgICAgICByZXR1cm4gc2NhbGVzW2ldO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIElmIG5vdGhpbmcgbWF0Y2hlcywgZGV2aWNlIHNjYWxlIGlzIGxhcmdlciB0aGFuIGFueSBhdmFpbGFibGVcbiAgICAvLyBzY2FsZXMsIHNvIHdlIHJldHVybiB0aGUgYmlnZ2VzdCBvbmUuIFVubGVzcyB0aGUgYXJyYXkgaXMgZW1wdHksXG4gICAgLy8gaW4gd2hpY2ggY2FzZSB3ZSBkZWZhdWx0IHRvIDFcbiAgICByZXR1cm4gc2NhbGVzW3NjYWxlcy5sZW5ndGggLSAxXSB8fCAxO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gQXNzZXRTb3VyY2VSZXNvbHZlcjtcbiJdfQ==